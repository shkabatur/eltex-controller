<!DOCTYPE html>
<html>
<head>
    <link rel="stylesheet" href="https://stackpath.bootstrapcdn.com/bootstrap/4.2.1/css/bootstrap.min.css" integrity="sha384-GJzZqFGwb1QTTN6wy59ffF1BuGJpLSa9DkKMp0DgiMDm4iYMj70gZWKYbI706tWS" crossorigin="anonymous"> 
    <title> LOL </title>
    <link rel="icon" type="image/png" href="https://static.artek.org/static/img/favicon.ico" />
</head>

<body>
    <div class="container-fluid">
		<div class="vue">
		<button type="button" class="btn" v-on:click='swap_cluster("audag")'>Аюдаг</button>
        <button type="button" class="btn" v-on:click='swap_cluster("guest")'>Гость</button>
		<div class="row">
		<div class="table-responsive col-md-6 table-striped">
		<table  class="table" >
			<thead>
				<tr>
					<th > <button type="button" class="btn btn-primary btn-block">Имя</button></th>
					<th > <button type="button" class="btn btn-primary btn-block">IP</button></th>
					<th > <button type="button" class="btn btn-primary btn-block">Мак-адрес</button></th>
					<th > <button type="button" class="btn btn-primary btn-block">Модель</button></th>
					<th > <button type="button" class="btn btn-primary btn-block">Статус</button></th>
					<th > <button type="button" class="btn btn-primary btn-block">Пинг</button></th>
					<th > <button type="button" class="btn btn-primary btn-block">Прошивка</button></th>
					<th > Перезагрузка</th>
				</tr>
			</thead>
			<tbody>
				<tr  v-for="node in nodes"> 
					<th>{{node.location}}</th>
					<td>{{node.ip}}</td>
					<td>{{node.mac}}</td>
					<td>{{node.compat}}</td>
					<td>
						<template v-if="node.status">
							<font color="green"> connected </font>
						</template>
						<template v-else>
							<font color="red"> disconnected </font>
						</template>
					</td>
					<td>{{ node.ping.toFixed(1) }}ms </td>
					<td> {{ node["firmware-version"] }} </td>
					<td> <button v-on:click='reboot(node.ip)' type="button" class="btn btn-danger"> restart </button> </td>
					<td> <button v-on:click='detail(node.ip)' type="button" class="btn btn-info"> подробно </button> </td>
				</tr>
			</tbody>
		</table>
		</div>
		
		<div class="table-responsive col-md-6 table-striped">
		<table  class="table" v-if="node_detail" >
			<thead>
				<tr>
					<th> IP</th>
					<th> Hostname</th>
					<th> Mac</th>
					<th> interface</th>
					<th> uptime</th>
					<th> rx-mb</th>
					<th> tx-mb</th>
				</tr>
			</thead>
			<tbody >
				<tr  v-for="node in node_detail"> 
					<th>{{node["ip-address"]}}</th>
					<td>{{node.hostname}}</td>
					<td>{{node.station}}</td>
					<template v-if="node.interface === 'wlan0'">
						<td>2.4 Ггц</td>
					</template>
					<template v-else>
						<td>5 Ггц</td>
					</template>
					<td>{{node.uptime}}</td>
					<td>{{(node["rx-bytes"] / 1024 / 1024).toFixed(2)}}</td>
					<td>{{(node["tx-bytes"] / 1024 / 1024).toFixed(2)}} </td>
					<td>{{node["firmware-version"]}} </td>
				</tr>
			</tbody>
		</table>
		</div>
	
	  </div>
	</div>
	</div>
</body>
    
    <script src="https://cdnjs.cloudflare.com/ajax/libs/axios/0.18.0/axios.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/vue"></script>
    <script type="text/javascript">
        var cluster_name = "audag";
        var vm = new Vue({
            el: '.vue',
            data: { 
                nodes : {},
                cluster_name: cluster_name,
				node_detail: {},
            },
            methods: {
                swap_cluster: function(name) {
                    vm.nodes = {};
                    vm.cluster_name = name;
					vm.fast_init();
                },
				detail: function(ip) {
					vm.node_detail = {};
					axios.post('/detail', {"ip": ip}).then(function(response){
						for(var key in response.data) {
								Vue.set(vm.node_detail, response.data[key].station, response.data[key])
						}
					});
				},
                reboot: function(ip){
                    if (confirm('Вы уверены ?')) {
                        axios.post('/reboot', {'ip': ip});
                    };
                },
				fast_init: function() {
					fetch(window.location.href + vm.cluster_name)
								.then(function(response){return response.json()})
								.then(function(data){
									for (var key in data) {
										Vue.set(vm.nodes, data[key].mac, data[key])
									}
								
								});
				},
            },
			//запускается сразу после монтирования всех компонентов, и начинает обновлять таблицу
			mounted : function() {
                fetch(window.location.href + cluster_name)
								.then(function(response){return response.json()})
								.then(function(data){
									for (var key in data) {
										Vue.set(vm.nodes, data[key].mac, data[key])
									}
								});
				this.$nextTick(function () {	
					setInterval(() => {
							fetch(window.location.href + vm.cluster_name)
								.then(function(response){return response.json()})
								.then(function(data){
									for (var key in data) {
										Vue.set(vm.nodes, data[key].mac, data[key])
									}
								
								});
					}, 5000);
				});
			},
        })
    </script>
</html>